## 坐标与布局选择
- 采用“odd-r 偏移坐标（pointy-top 六边形）”，继续沿用当前二维数组 `grid[y][x]` 的数据结构，保持存取与边界判断不变。
- 六边形像素坐标（中心点）计算：
  - `cx = size * sqrt(3) * (x + 0.5 * (y & 1))`
  - `cy = size * (3/2) * y + ui_top`
- 邻居（6方向）基于行奇偶的偏移表：
  - 偶行 `y%2==0`：`[(+1,0),(-1,0),(0,+1),(0,-1),(-1,+1),(-1,-1)]`
  - 奇行 `y%2==1`：`[(+1,0),(-1,0),(0,+1),(0,-1),(+1,+1),(+1,-1)]`
- 距离使用六边形距离（odd-r→cube 转换后计算）：`hex_distance(a,b)`。

## Python 逻辑改造
- `utils/common.py`
  - 新增：`hex_neighbors(x,y) -> list[(x,y)]`（按奇偶行）
  - 新增：`hex_to_cube(x,y) -> (cx, cy, cz)` 与 `hex_distance(a,b)`
  - 保留原有方法但在调用处切换至 hex 版本。
- `core/map.py`
  - `Map` 不变（二维存储），但生成算法改为支持“河流”和“山脊”的连贯线条：
    - 河流：沿着一条 `hex_neighbors` 形成的链（支持断点 `gap`）
    - 山脊：随机分布 + 连续段
- `core/state.py`
  - `serialize()/deserialize()` 增加 `grid_type: 'hex'` 与 `layout: 'odd-r'` 字段，让前端了解渲染方式。
- `simulation/loop.py`
  - `spawn_from_base()`：邻接格使用 `hex_neighbors`。
  - 移动：`step_towards(unit, dest)` 修改为“选取 6 邻居中使 `hex_distance(next, dest)` 最小且可走的格子”，每点速度重复执行。
  - 随机游走：从 `hex_neighbors` 中随机选择可走格。
- `ai/policy.py`
  - 可见性和射程判断切换至 `hex_distance()`（视野与射程基于六边形距离）。
  - 两阶段策略 `TwoPhasePolicy` 保持，进攻与探索基于 hex 距离。
- 视线遮挡（Bresenham → Hex Line）
  - 在 `renderer/pygame_renderer.py` 里替换 LOS：采用 cube 线性插值与 rounding 的 `hex_line(a,b)`，遍历线段各格，遇到山则阻断（河流不阻断）。

## Pygame 图形渲染改造
- `renderer/pygame_renderer.py`
  - 方格→六边形：`render_map()` 按每格中心点绘制 6 边形多边形（pointy-top），地形颜色沿用。
  - 单位与基地：以六边形中心点为基准绘制（单位圆/矩形/三角仍可保留，但位置跟随中心点）。
  - 基地血条：移至格外侧（不与地图叠加），顶部 HUD 保持分区（feed 24px + HUD 64px）。
  - 视野遮罩：未可见格在六边形多边形上叠半透明遮罩。
  - 永久基地标记：不可见但已知位置用六边形描边标注（不填充）。
- 坐标换算与尺寸
  - 新增 `hex_center(x,y)` 与 `hex_polygon(cx,cy,size)` 帮助函数；`cell_size` 作为六边形半径（顶点到中心）。
  - 全部基于 `odd-r + pointy-top` 公式，避免 UI 与地图叠加（沿用已设置的 `ui_top`）。

## Web 前端改造
- `web/app.js`
  - 根据 `state.map.grid_type === 'hex'` 切换渲染分支，按与 Pygame 一致的 `odd-r + pointy-top` 公式绘制六边形（Canvas `path`）。
  - 单位与基地位置使用六边形中心点。
  - HUD 保持不变（若前端有显示）。
- `web/index.html`/`styles.css`
  - 维持现有布局；若需要，将顶部信息区与地图分离（与 Pygame 对齐）。

## 兼容与开关
- 在 `GameState` 中增加 `grid_type` 与 `layout` 字段；默认迁移到 `hex/odd-r`。
- 保留少量工具的方格实现（如 CharRenderer 可暂不更新或标记禁用）。

## 验证与测试
- 单元测试（Python）：
  - `hex_neighbors` 在边界与奇偶行的正确性
  - `hex_distance` 与 `hex_line` 正确性（与 Red Blob 公式对齐）
  - 移动与随机游走在复杂地形下的连贯性
- 交互测试（Pygame）：
  - 地图绘制为六边形网格，视野遮挡与永久标记正常
  - 基地生产、单位探索与总攻行为合理，HUD 与控制面板不重叠
- 前端测试（Web）：
  - Canvas 六边形渲染与单位/基地位置对齐；状态拉取正常

## 变更清单（文件级）
- 新/改函数：`utils/common.py`（hex 邻居/距离/线）
- 更新：`simulation/loop.py`（移动/游走/生产）
- 更新：`ai/policy.py`（距离判断）
- 更新：`renderer/pygame_renderer.py`（六边形绘制、LOS、坐标换算）
- 更新：`core/state.py`（序列化添加 grid_type/layout）
- 更新：`web/app.js`（Canvas 渲染六边形）

## 风险与应对
- 距离与视线算法迁移：引用成熟公式（cube 坐标），以测试保障。
- 性能：六边形多边形绘制较矩形略慢；通过减少每帧重复计算（缓存顶点）优化。
- 前后端一致性：以 `grid_type/layout` 协调，保证渲染一致。

确认后我将按上述计划分批实现，并在每一步进行运行验证与 UI 叠加检查，确保迁移到六边形后玩法与显示均正确。