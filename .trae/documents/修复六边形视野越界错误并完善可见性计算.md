## 问题定位
- 报错位置：`renderer/pygame_renderer.py:224` 在 `compute_visibility` 中访问 `gamestate.map.grid[py][px]` 越界。
- 根因：`hex_line((ex,ey),(x,y))` 返回的中间点可能超出地图边界；当前代码未对 `px, py` 做边界检查，也未限制 `x, y` 到视野半径内的六边形距离。

## 修复方案
- 在 `compute_visibility` 内对候选目标格做两层约束：
  - 仅遍历地图边界内的格；并添加 `hex_distance((ex,ey),(x,y)) <= r` 过滤。
  - 对 `hex_line` 返回的每个线段点逐一边界检查：
    - 若 `not in_bounds(px,py)` 则中止该目标格的判定（不加入可见集）。
    - 继续保持“山阻挡视线、河流不阻挡”的逻辑。
- 读取地形前一律使用 `in_bounds` 判断：`if not gamestate.map.in_bounds(px, py): break`。
- 保留永久基地标记逻辑，视野遮罩绘制不变。

## 具体改动
- 文件：`renderer/pygame_renderer.py`
  - 函数：`compute_visibility(gamestate, side)`
    1. 外层遍历范围仍为 `[max(0,ey-r) .. min(h,ey+r)]`，再筛选 `hex_distance <= r`。
    2. 内层遍历 `hex_line` 点时，先做 `in_bounds` 检查；越界即 `blocked=True` 并 `break`。
    3. 地形读取统一在边界判断后进行。
- 可选安全增强（如需）：
  - 在 `utils/common.hex_line` 前置裁剪端点到边界，但为保持算法简洁，先在 `compute_visibility` 做守护。

## 验证
- 新增/执行以下用例（手动或脚本）：
  - 边界位置单位的视野，不再触发 IndexError。
  - 在边界外的目标格不会被加入可见集。
  - 山体阻挡：两格之间有山，目标不可见；河流不阻挡：目标可见。
- Pygame 端运行：边缘单位移动时视野正常，窗口不再闪退；UI 区与地图不交叠。

## 性能与影响
- 额外的 `in_bounds` 与距离检查为 O(r²) 范围内轻量操作；与现有每帧渲染复杂度相当。
- 不影响现有两阶段 AI、HUD、暂停/倍速功能。

确认后我将按以上方案修改 `compute_visibility` 并进行运行验证，确保越界问题彻底解决。